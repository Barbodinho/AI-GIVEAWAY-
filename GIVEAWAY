#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Raffle Bot (pure stdlib)
- Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø§Ø¶Ø§ÙÛŒ
- Ù†ØµØ¨ ØªØ¹Ø§Ù…Ù„ÛŒ (ØªÙˆÚ©Ù† Ùˆ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ø¯Ø± config.json Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)
"""

import json, os, random, time, urllib.request, urllib.parse, sys

HERE = os.path.dirname(os.path.abspath(__file__))
F_CONFIG  = os.path.join(HERE, "config.json")
F_STATE   = os.path.join(HERE, "state.json")
F_PART    = os.path.join(HERE, "participants.json")
F_WIN     = os.path.join(HERE, "winners.json")
F_CHANNEL = os.path.join(HERE, "required_channels.json")

# ========== IO helpers ==========
def load_json(path, default):
    try:
        with open(path, "r", encoding="utf-8") as f: return json.load(f)
    except Exception: return default

def save_json(path, obj):
    tmp = path + ".tmp"
    with open(tmp, "w", encoding="utf-8") as f:
        json.dump(obj, f, ensure_ascii=False, indent=2)
    os.replace(tmp, path)

def ensure_config():
    cfg = load_json(F_CONFIG, {})
    token = cfg.get("bot_token", "").strip()
    admins = cfg.get("admin_ids", [])
    draw_text = cfg.get("draw_text", "ÙØ±Ø¯Ø§ Ø³Ø§Ø¹Øª 20:00")

    if not token:
        print("ğŸ”‘ ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ø§Ø² @BotFather):")
        token = input("> ").strip()
    if not admins:
        print("ğŸ‘‘ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†) â€“ Ø§Ø² @userinfobot Ø¨Ú¯ÛŒØ±:")
        raw = input("> ").strip()
        admins = [int(x) for x in raw.replace("ØŒ",",").split(",") if x.strip().isdigit()]

    cfg = {"bot_token": token, "admin_ids": admins, "draw_text": draw_text}
    save_json(F_CONFIG, cfg)
    return cfg

CFG        = ensure_config()
BOT_TOKEN  = CFG["bot_token"]
ADMIN_IDS  = set(CFG["admin_ids"])
DRAW_TEXT  = CFG["draw_text"]

API = f"https://api.telegram.org/bot{BOT_TOKEN}"

# ========== API ==========
def api_get(method, params=None):
    url = API + "/" + method
    if params: url += "?" + urllib.parse.urlencode(params)
    with urllib.request.urlopen(url) as r:
        return json.loads(r.read().decode("utf-8"))

def api_post(method, payload):
    req = urllib.request.Request(
        API + "/" + method,
        data=json.dumps(payload).encode("utf-8"),
        headers={"Content-Type": "application/json"},
    )
    with urllib.request.urlopen(req) as r:
        return json.loads(r.read().decode("utf-8"))

def send_message(chat_id, text, reply_markup=None, parse_mode=None):
    p = {"chat_id": chat_id, "text": text}
    if reply_markup: p["reply_markup"] = reply_markup
    if parse_mode:   p["parse_mode"]   = parse_mode
    return api_post("sendMessage", p)

def edit_message(chat_id, message_id, text, reply_markup=None, parse_mode=None):
    p = {"chat_id": chat_id, "message_id": message_id, "text": text}
    if reply_markup: p["reply_markup"] = reply_markup
    if parse_mode:   p["parse_mode"]   = parse_mode
    return api_post("editMessageText", p)

def answer_cb(cb_id, text=None, alert=False):
    p = {"callback_query_id": cb_id}
    if text is not None:
        p["text"] = text; p["show_alert"] = bool(alert)
    return api_post("answerCallbackQuery", p)

def get_member(chat_id, user_id):
    try:    return api_get("getChatMember", {"chat_id": chat_id, "user_id": user_id})
    except: return {"ok": False}

# ========== Data ==========
state        = load_json(F_STATE,   {"offset": 0})
participants = load_json(F_PART,    {})   # str(user_id) -> info
winners      = load_json(F_WIN,     {})   # str(user_id) -> won_at
channels     = load_json(F_CHANNEL, [])   # ["@ch1", "@ch2"]

# ========== Helpers ==========
def is_admin(uid: int) -> bool:
    return uid in ADMIN_IDS

def already_registered(uid: int) -> bool:
    return str(uid) in participants

def not_joined_channels(uid: int):
    miss = []
    for ch in channels:
        resp = get_member(ch, uid)
        if not resp.get("ok"):                    # Ù†ØªÙˆÙ†Ø³Øª Ú†Ú© Ú©Ù†Ù‡ â†’ Ù…Ø¬Ø¨ÙˆØ±ÛŒÙ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ù†ÛŒÙ…
            miss.append(ch); continue
        if resp["result"]["status"] in ("left","kicked"):
            miss.append(ch)
    return miss

def add_participant(user):
    participants[str(user["id"])] = {
        "first_name": user.get("first_name",""),
        "username":   user.get("username",""),
        "joined_at":  time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()),
    }
    save_json(F_PART, participants)

def list_candidates():
    return [(int(uid), i.get("first_name",""), i.get("username",""))
            for uid,i in participants.items() if uid not in winners]

def draw_winner():
    pool = list_candidates()
    if not pool: return None
    u, fn, un = random.choice(pool)
    winners[str(u)] = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
    save_json(F_WIN, winners)
    return u, fn, un

# ========== UI (prettier buttons) ==========
BOLD_JOINED_TEXT = "ğ—”ğ——ğ—— ğ—–ğ—¢ğ—¡ğ—™ğ—œğ—¥ğ— "  # Ø­Ø±ÙˆÙ Ø¶Ø®ÛŒÙ… ÛŒÙˆÙ†ÛŒÚ©Ø¯ (Ø¸Ø§Ù‡Ø± Ø¨ÙˆÙ„Ø¯)
def remaining_keyboard(uid: int):
    rows = []
    for ch in not_joined_channels(uid):
        rows.append([{"text": f"ğŸ”— ğ—ğ—¢ğ—œğ—¡: {ch}", "url": f"https://t.me/{ch.lstrip('@')}"}])
    rows.append([
        {"text": "âœ… ğ—®ğ—¿ğ—²  Ø¹Ø¶Ù€Ù€Ùˆ Ø´Ø¯Ù…", "callback_data": "verify_join"},
        {"text": "ğŸ” Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ",       "callback_data": "refresh"}
    ])
    return {"inline_keyboard": rows}

def confirm_only_keyboard():
    return {"inline_keyboard":[
        [
            {"text": "âœ… ğ—®ğ—¿ğ—²  Ø¹Ø¶Ù€Ù€Ùˆ Ø´Ø¯Ù…", "callback_data": "verify_join"},
            {"text": "ğŸ” Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ",       "callback_data": "refresh"}
        ]
    ]}

# ========== Commands ==========
def cmd_start(chat_id: int, user):
    uid = user["id"]
    if already_registered(uid):
        joined_at = participants[str(uid)].get("joined_at","")
        return send_message(
            chat_id,
            ("âœ… Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯."
             + (f"\nğŸ—“ ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª: {joined_at}" if joined_at else "")),
        )

    if channels:
        missing = not_joined_channels(uid)
        if missing:
            text = "Ø³Ù„Ø§Ù…! ğŸ‘‹\nâ­ï¸ Ù„Ø·ÙØ§Ù‹ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Â«Ø¹Ø¶Ùˆ Ø´Ø¯Ù…Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯:"
            text += "\n\n" + "\n".join(f"â€¢ {c}" for c in missing)
            return send_message(chat_id, text, reply_markup=remaining_keyboard(uid))
        else:
            return send_message(
                chat_id,
                "Ø¹Ø§Ù„ÛŒ! Ø´Ù…Ø§ Ø¹Ø¶Ùˆ Ù‡Ù…Ù‡Ù” Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ù‡Ø³ØªÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø«Ø¨ØªØŒ Ø±ÙˆÛŒ Â«Ø¹Ø¶Ùˆ Ø´Ø¯Ù…Â» Ø¨Ø²Ù†ÛŒØ¯.",
                reply_markup=confirm_only_keyboard()
            )
    else:
        return send_message(
            chat_id,
            "Ø³Ù„Ø§Ù…! ğŸ‘‹\n(ÙØ¹Ù„Ø§Ù‹ Ú©Ø§Ù†Ø§Ù„ Ø§Ø¬Ø¨Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.) Ø¨Ø±Ø§ÛŒ Ø´Ø±Ú©Øª Ø¯Ø± Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Â«Ø¹Ø¶Ùˆ Ø´Ø¯Ù…Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.",
            reply_markup=confirm_only_keyboard()
        )

def cmd_setchannels(chat_id: int, uid: int, args):
    if not is_admin(uid): return send_message(chat_id, "â›”ï¸ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª.")
    if not args:          return send_message(chat_id, "Ù†Ø­ÙˆÙ‡: /setchannels @ch1 @ch2 ...")
    newchs = []
    for a in args:
        a = a.strip()
        if not a: continue
        if not a.startswith("@"): a = "@" + a
        newchs.append(a)
    global channels
    channels = newchs
    save_json(F_CHANNEL, channels)
    return send_message(chat_id, "âœ… Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯:\n" + "\n".join(f"â€¢ {c}" for c in channels))

def cmd_channels(chat_id: int):
    return send_message(chat_id, "Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§:\n" + ("\n".join(f"â€¢ {c}" for c in channels) if channels else "â€”"))

def cmd_participants(chat_id: int, uid: int):
    if not is_admin(uid): return send_message(chat_id, "â›”ï¸ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª.")
    if not participants:  return send_message(chat_id, "ÙØ¹Ù„Ø§Ù‹ Ú©Ø³ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.")
    lines = [f"{i+1}. {v.get('first_name','')} (@{v.get('username','')}) â€“ {k}"
             for i,(k,v) in enumerate(participants.items())]
    return send_message(chat_id, "\n".join(lines)[:4000])

def cmd_winners(chat_id: int, uid: int):
    if not is_admin(uid): return send_message(chat_id, "â›”ï¸ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª.")
    if not winners:       return send_message(chat_id, "ØªØ§ Ø§Ù„Ø§Ù† Ø¨Ø±Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒÙ….")
    rows = sorted(winners.items(), key=lambda x: x[1], reverse=True)
    lines = []
    for i,(pid,when) in enumerate(rows,1):
        info = participants.get(pid, {})
        lines.append(f"{i}. {info.get('first_name','')} (@{info.get('username','')}) â€“ {pid} | {when}")
    return send_message(chat_id, "\n".join(lines)[:4000])

def cmd_reset(chat_id: int, uid: int, arg: str):
    if not is_admin(uid): return send_message(chat_id, "â›”ï¸ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª.")
    global participants, winners
    if arg == "winners":
        winners = {}; save_json(F_WIN, winners); return send_message(chat_id, "âœ… Ù„ÛŒØ³Øª Ø¨Ø±Ù†Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯.")
    elif arg == "all":
        winners, participants = {}, {}; save_json(F_WIN, winners); save_json(F_PART, participants)
        return send_message(chat_id, "âœ… Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² Ø±ÛŒØ³Øª Ø´Ø¯.")
    else:
        return send_message(chat_id, "Ù†Ø­ÙˆÙ‡: /reset winners  ÛŒØ§  /reset all")

def cmd_random(chat_id: int, uid: int):
    if not is_admin(uid): return send_message(chat_id, "â›”ï¸ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª.")
    w = draw_winner()
    if not w: return send_message(chat_id, "Ú©Ø³ÛŒ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ù†ÛŒØ³Øª.")
    u, fn, un = w
    mention = f"[{fn}](tg://user?id={u})" if fn else f"Ú©Ø§Ø±Ø¨Ø± {u}"
    at = f"@{un}" if un else ""
    return send_message(chat_id, f"ğŸ‰ Ø¨Ø±Ù†Ø¯Ù‡: {mention} {at}\nâ° {DRAW_TEXT}", parse_mode="Markdown")

# ========== Update handling ==========
def on_message(msg):
    chat = msg["chat"]["id"]; user = msg["from"]
    text = (msg.get("text") or "").strip()
    if not text.startswith("/"): return
    parts = text.split(); cmd = parts[0].lower(); args = parts[1:]
    if   cmd == "/start":        cmd_start(chat, user)
    elif cmd == "/setchannels":  cmd_setchannels(chat, user["id"], args)
    elif cmd == "/channels":     cmd_channels(chat)
    elif cmd == "/participants": cmd_participants(chat, user["id"])
    elif cmd == "/winners":      cmd_winners(chat, user["id"])
    elif cmd == "/reset":        cmd_reset(chat, user["id"], args[0].lower() if args else "")
    elif cmd == "/random":       cmd_random(chat, user["id"])
    elif cmd == "/join":
        if already_registered(user["id"]): send_message(chat, "âœ… Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.")
        else: send_message(chat, "Ø¨Ø±Ø§ÛŒ Ø§ØªÙ…Ø§Ù… Ø«Ø¨ØªØŒ Ø±ÙˆÛŒ Â«Ø¹Ø¶Ùˆ Ø´Ø¯Ù…Â» Ø¨Ø²Ù†ÛŒØ¯.", reply_markup=remaining_keyboard(user["id"]))

def on_callback(cb):
    cb_id = cb["id"]; uid = cb["from"]["id"]
    msg   = cb["message"]; chat = msg["chat"]["id"]; mid = msg["message_id"]
    data  = cb.get("data","")
    if data == "refresh":
        # Ù…ØªÙ† Ùˆ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø±Ø§ Ø¨Ø§ ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†
        missing = not_joined_channels(uid)
        if missing:
            txt = "Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø´ÙˆÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Â«Ø¹Ø¶Ùˆ Ø´Ø¯Ù…Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯:\n\n" + "\n".join(f"â€¢ {c}" for c in missing)
            edit_message(chat, mid, txt, reply_markup=remaining_keyboard(uid))
        else:
            edit_message(chat, mid, "Ø¹Ø§Ù„ÛŒ! Ø¹Ø¶Ùˆ ØªÙ…Ø§Ù… Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ù‡Ø³ØªÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø«Ø¨ØªØŒ Â«Ø¹Ø¶Ùˆ Ø´Ø¯Ù…Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.",
                         reply_markup=confirm_only_keyboard())
        answer_cb(cb_id)
    elif data == "verify_join":
        if already_registered(uid):
            answer_cb(cb_id, "Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ âœ…")
            return send_message(chat, "âœ… Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.")
        missing = not_joined_channels(uid)
        if missing:
            answer_cb(cb_id, "Ù‡Ù†ÙˆØ² Ø¹Ø¶Ùˆ Ù‡Ù…Ù‡ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ù†ÛŒØ³ØªÛŒØ¯.", alert=True)
            return send_message(chat, "ğŸ”” Ù‡Ù†ÙˆØ² Ø§ÛŒÙ† Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡â€ŒØ§Ù†Ø¯:\n" + "\n".join(f"â€¢ {c}" for c in missing),
                                reply_markup=remaining_keyboard(uid))
        add_participant(cb["from"])
        answer_cb(cb_id, "Ø«Ø¨Øª Ø´Ø¯ âœ…")
        send_message(chat, f"âœ… Ø´Ù…Ø§ Ø¯Ø± Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø«Ø¨Øª Ø´Ø¯ÛŒØ¯!\nâ° Ø²Ù…Ø§Ù† Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ: {DRAW_TEXT}\nÙ…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯ ğŸ€")

# ========== Main loop ==========
def main():
    print("Raffle bot (stdlib) started.")
    while True:
        try:
            upd = api_get("getUpdates", {"timeout":50, "offset": load_json(F_STATE, {"offset":0})["offset"] + 1})
            if not upd.get("ok"): time.sleep(2); continue
            for u in upd["result"]:
                state = {"offset": u["update_id"]}; save_json(F_STATE, state)
                if "message" in u:          on_message(u["message"])
                elif "callback_query" in u: on_callback(u["callback_query"])
        except KeyboardInterrupt:
            print("Stopped."); break
        except Exception as e:
            print("Error:", e); time.sleep(3)

if __name__ == "__main__":
    main()
